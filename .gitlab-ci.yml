variables:
  DOCKER_BUILDKIT: 0
  AWS_DEFAULT_REGION: eu-west-1
  ECR_REGISTRY: 723216754178.dkr.ecr.eu-west-1.amazonaws.com

default:
  tags:
    - aws-edgez-prd-k8s

include:
  - component: gitlab.netlight.com/components/opentofu/validate-plan-apply@2.6.1
    inputs:
      opentofu_version: 1.9.1
      root_dir: infra
      job_name_prefix: "aws-"
  - component: $CI_SERVER_FQDN/components/docker-build/buildkit@main
    inputs:
      tags: aws-edgez-prd-k8s
      name: simplesim-backend
      job_prefix: backend-
      dockerfile: Dockerfile.backend
      environment: prod
  - component: $CI_SERVER_FQDN/components/docker-build/buildkit@main
    inputs:
      tags: aws-edgez-prd-k8s
      name: simplesim-frontend
      job_prefix: frontend-
      dockerfile: Dockerfile.frontend
      environment: prod

stages: [validate, build, test, deploy]

deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - |
      # Apply deployments
      echo "Applying backend deployment..."
      kubectl apply -f k8s/backend-deployment.yaml
      
      echo "Applying frontend deployment..."
      kubectl apply -f k8s/frontend-deployment.yaml
      
      # Check deployment status
      echo "Checking backend deployment status..."
      kubectl rollout status deployment/simplesim-backend -n simplesim
      
      echo "Checking frontend deployment status..."
      kubectl rollout status deployment/simplesim-frontend -n simplesim
  tags:
    - aws-edgez-prd-k8s
  only:
    - main
    - master
